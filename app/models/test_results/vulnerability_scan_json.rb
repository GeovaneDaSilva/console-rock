module TestResults
  # :nodoc
  class VulnerabilityScanJson < BaseJson
    def vuln_array(json)
      return unless json.is_a? String

      v_array = JSON.parse(json)
      v_array = v_array.sort_by { |hsh| hsh["cvss_score"].to_f }.reverse

      v_array
    end

    def cve_list(vuln)
      cves = ""

      vuln["ref_ids"].each do |ref|
        if ref =~ /^CVE/
          cves += "<a href=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=#{ref}\" \
                  target=\"_blank\">#{ref} </a> "
        end
      end

      cves
    end

    def ref_list(vuln)
      refs = ""

      vuln["ref_ids"].each do |ref|
        if ref =~ /^KB/
          refs += "<a href=\"https://support.microsoft.com/en-us/help/#{ref.gsub('KB', '')}\" \
                  target=\"_blank\">#{ref} </a> "
        end
        if ref =~ /^aps/i
          refs += "<a href=\"http://www.adobe.com/support/security/bulletins/#{ref}.html\" \
                   target=\"_blank\">#{ref} </a> "
        end
        if ref =~ /^^MS[0-9][0-9]-[0-9][0-9]/i
          refs += "<a href=\"#{vuln['ref_urls'].grep(ref)}\" target=\"_blank\">#{ref} </a>"
        end
      end

      refs
    end
  end
end
